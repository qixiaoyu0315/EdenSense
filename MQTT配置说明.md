# EdenSense MQTT配置说明

## MQTT功能概述

EdenSense项目现已支持MQTT协议，可以通过MQTT服务器进行远程数据获取和控制。

## 功能特性

- **自动连接**: 设备启动时自动连接MQTT服务器
- **自动重连**: 连接丢失时自动尝试重新连接
- **命令响应**: 订阅命令主题，响应refresh命令
- **数据发布**: 按需发布温度数据到指定主题
- **JSON格式**: 使用标准JSON格式传输数据

## 配置步骤

1. 打开 `src/main.cpp` 文件
2. 找到MQTT配置参数（大约在第25-32行）：
   ```cpp
   #define MQTT_SERVER "ebd16e9d.ala.cn-hangzhou.emqxsl.cn"  // MQTT服务器地址
   #define MQTT_PORT 8883               // MQTT服务器端口
   #define MQTT_CLIENT_ID "esp32c3print"  // MQTT客户端ID
   #define MQTT_USERNAME "esp32c3print"             // MQTT用户名（如果需要）
   #define MQTT_PASSWORD "yjMMjxnbcPNifc8"             // MQTT密码（如果需要）
   #define MQTT_SUBSCRIBE_TOPIC "testtopic"  // 订阅主题
   #define MQTT_PUBLISH_TOPIC "testtopic"       // 发布主题
   ```

3. 修改配置参数：
   - `MQTT_SERVER`: 您的MQTT服务器地址
   - `MQTT_PORT`: MQTT服务器端口（SSL连接使用8883，普通连接使用1883）
   - `MQTT_CLIENT_ID`: 客户端唯一标识符
   - `MQTT_USERNAME`: 用户名（如果服务器需要认证）
   - `MQTT_PASSWORD`: 密码（如果服务器需要认证）
   - `MQTT_SUBSCRIBE_TOPIC`: 订阅的命令主题
   - `MQTT_PUBLISH_TOPIC`: 发布数据的主题

4. **SSL配置**（对于EMQX云服务）：
   ```cpp
   #define MQTT_USE_SSL true  // 启用SSL连接
   ```
   - 对于EMQX云服务，需要启用SSL连接
   - 代码会自动配置SSL证书验证
   - 使用端口8883进行SSL连接

## 使用方法

### 1. 获取温度数据

向订阅主题发送 `refresh` 命令：

**对于SSL连接（EMQX云服务）**：
```bash
mosquitto_pub -h ebd16e9d.ala.cn-hangzhou.emqxsl.cn -p 8883 -u esp32c3print -P yjMMjxnbcPNifc8 -t "testtopic" -m "refresh" --cafile /path/to/ca.crt
```

**对于普通连接**：
```bash
mosquitto_pub -h 192.168.1.100 -t "edensense/command" -m "refresh"
```

### 2. 接收温度数据

订阅发布主题以接收数据：

**对于SSL连接（EMQX云服务）**：
```bash
mosquitto_sub -h ebd16e9d.ala.cn-hangzhou.emqxsl.cn -p 8883 -u esp32c3print -P yjMMjxnbcPNifc8 -t "testtopic" --cafile /path/to/ca.crt
```

**对于普通连接**：
```bash
mosquitto_sub -h 192.168.1.100 -t "edensense/data"
```

## 数据格式

设备会返回以下JSON格式的数据：

```json
{
  "T1-28FF12345678": {
    "c_t": "28.5",
    "l_t": [22.1, 21.9, 21.7, 21.5, 21.3, 21.1, 20.9, 21.0, 21.8, 23.5, 25.5, 27.8, 29.8, 31.2, 32.1, 32.5, 32.6, 32.2, 31.3, 29.8, 28.0, 26.2, 24.6, 23.3, 22.5, 22.2, 22.0, 21.8, 21.6, 21.4, 21.2, 21.0, 21.3, 22.4, 24.3, 26.7, 29.0, 30.7, 31.8, 32.4, 32.7, 32.5, 31.8, 30.5, 28.7, 26.8, 25.1, 23.7, 22.8, 22.4, 22.2, 22.0, 21.8, 21.6, 21.4, 21.2, 21.0, 21.2, 22.1, 23.9, 26.2, 28.5, 30.3, 31.5, 32.2, 32.5, 32.4, 31.9, 30.8, 29.2, 27.3, 25.5, 24.0, 23.0, 22.5, 22.2, 22.0, 21.8, 21.6, 21.4, 21.2, 21.0, 21.1, 21.9, 23.7, 26.0, 28.3, 30.1, 31.3, 32.0, 32.3, 32.2, 31.7, 30.6, 29.0, 27.1, 25.3, 23.8, 22.8, 22.3, 22.0, 21.8, 21.6, 21.4, 21.2, 21.0, 21.1, 21.8, 23.6, 25.9, 28.2, 30.0, 31.2, 31.9, 32.2]
  },
  "T2-28FF87654321": {
    "c_t": "25.5",
    "l_t": [20.5, 20.4, 20.3, 20.2, 20.1, 20.0, 20.1, 20.3, 21.2, 22.8, 24.7, 26.8, 28.5, 29.7, 30.5, 30.9, 31.0, 30.7, 30.0, 28.8, 27.3, 25.7, 24.2, 23.0, 22.2, 21.9, 21.7, 21.5, 21.3, 21.1, 21.0, 20.9, 21.3, 22.5, 24.4, 26.5, 28.4, 29.8, 30.7, 31.2, 31.4, 31.2, 30.6, 29.5, 28.0, 26.4, 24.9, 23.6, 22.7, 22.3, 22.1, 21.9, 21.7, 21.5, 21.3, 21.1, 21.0, 21.2, 22.1, 23.8, 25.9, 27.8, 29.2, 30.1, 30.6, 30.8, 30.7, 30.2, 29.2, 27.8, 26.2, 24.7, 23.4, 22.5, 22.1, 21.9, 21.7, 21.5, 21.3, 21.1, 21.0, 20.9, 21.1, 22.0, 23.7, 25.8, 27.7, 29.1, 30.0, 30.5, 30.7, 30.6, 30.1, 29.1, 27.7, 26.1, 24.6, 23.3, 22.4, 22.0, 21.8, 21.6, 21.4, 21.2, 21.0, 20.9, 21.0, 21.9, 23.6, 25.7, 27.6, 29.0, 29.9, 30.4, 30.6]
  },
  "T3-28FFABCDEF12": {
    "c_t": "23.5",
    "l_t": [23.8, 23.7, 23.6, 23.5, 23.4, 23.3, 23.2, 23.3, 23.5, 23.8, 24.2, 24.7, 25.3, 25.8, 26.2, 26.5, 26.7, 26.6, 26.3, 25.9, 25.5, 25.1, 24.7, 24.4, 24.1, 24.0, 23.9, 23.8, 23.7, 23.6, 23.5, 23.4, 23.5, 23.8, 24.2, 24.7, 25.3, 25.8, 26.2, 26.5, 26.7, 26.6, 26.3, 25.9, 25.5, 25.1, 24.7, 24.4, 24.1, 24.0, 23.9, 23.8, 23.7, 23.6, 23.5, 23.4, 23.3, 23.4, 23.7, 24.1, 24.6, 25.2, 25.7, 26.1, 26.4, 26.6, 26.5, 26.2, 25.8, 25.4, 25.0, 24.6, 24.3, 24.0, 23.9, 23.8, 23.7, 23.6, 23.5, 23.4, 23.3, 23.2, 23.3, 23.6, 24.0, 24.5, 25.1, 25.6, 26.0, 26.3, 26.5, 26.4, 26.1, 25.7, 25.3, 24.9, 24.5, 24.2, 24.0, 23.9, 23.8, 23.7, 23.6, 23.5, 23.4, 23.3, 23.4, 23.7, 24.1, 24.6, 25.2, 25.7, 26.1, 26.4, 26.5]
  }
}
```

### 数据字段说明

- `T1-28FF12345678`, `T2-28FF87654321`, `T3-28FFABCDEF12`: 传感器标识符（T1-序列号格式）
- `c_t`: 当前温度值（字符串格式，保留1位小数）
- `l_t`: 历史温度数组（最多120个数据点）

## 连接流程

1. **WiFi连接**: 首先连接到WiFi网络
2. **MQTT连接**: WiFi连接成功后自动连接MQTT服务器
3. **主题订阅**: 连接成功后订阅命令主题
4. **消息处理**: 监听并处理接收到的命令
5. **数据发布**: 收到refresh命令后发布温度数据

## 调试信息

MQTT连接过程中的详细信息会通过串口输出，包括：
- 连接状态
- 订阅状态
- 接收到的消息
- 发布的数据内容
- 错误信息

## 注意事项

- 确保MQTT服务器在设备网络范围内
- 检查MQTT服务器端口是否正确
- 如果使用认证，请正确配置用户名和密码
- 设备会自动重试连接，无需手动干预
- JSON数据大小约为8KB，确保MQTT服务器支持足够大的消息
- **SSL连接注意事项**：
  - EMQX云服务使用SSL连接（端口8883）
  - 代码已配置为跳过证书验证（setInsecure）
  - 确保网络环境支持SSL连接
  - 如果连接失败，检查用户名密码是否正确 