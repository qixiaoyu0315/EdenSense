# EdenSense 电源管理说明

## 设备断电问题分析

ESP32-C3在使用过程中出现1-2分钟断电的问题，可能由以下原因导致：

### 1. 电源问题（最常见）

**USB供电不足**：
- ESP32-C3在WiFi+MQTT+显示屏工作时功耗较高
- 建议使用5V/2A以上的电源适配器
- 避免使用电脑USB口供电（电流限制500mA）

**充电器识别问题**：
- 某些智能充电器会检测负载
- 低负载时可能自动断电
- 建议使用普通充电器或USB电源

**USB线质量问题**：
- 劣质USB线内阻大，电压降严重
- 建议使用优质USB线（支持2A以上电流）

### 2. 代码优化措施

**已实施的功耗优化**：
- CPU频率降低到80MHz
- WiFi发射功率设置为8dBm
- 屏幕亮度可调节（默认128/255）
- 禁用WiFi睡眠模式
- MQTT保活时间设置为60秒

**电源管理配置**：
```cpp
#define SCREEN_BRIGHTNESS 128        // 屏幕亮度 (0-255)
#define MQTT_KEEPALIVE 60            // MQTT保活时间 (秒)
#define WIFI_SLEEP_DISABLE true      // 禁用WiFi睡眠模式
#define CPU_FREQ_MHZ 80              // CPU频率 (80MHz)
```

### 3. 硬件建议

**电源适配器**：
- 推荐：5V/2A 或 5V/3A
- 避免：电脑USB口、低功率充电器

**USB线**：
- 推荐：优质USB-C线，支持2A以上电流
- 避免：劣质、过长的USB线

**散热**：
- 确保设备有足够散热空间
- 避免在高温环境下使用

## 故障排除步骤

### 1. 检查电源
```bash
# 使用万用表测量USB口电压
# 正常值：4.8V-5.2V
```

### 2. 监控串口输出
设备会输出电源状态信息：
```
=== 电源状态监控 ===
运行时间: 300 秒
CPU频率: 80 MHz
WiFi状态: 已连接
MQTT状态: 已连接
可用内存: 123456 字节
==================
```

### 3. 降低功耗测试
如果问题持续，可以尝试：
- 降低屏幕亮度：`#define SCREEN_BRIGHTNESS 64`
- 进一步降低WiFi功率：`#define WIFI_POWER_DBM 4`
- 增加MQTT保活时间：`#define MQTT_KEEPALIVE 120`

### 4. 硬件检查
- 检查USB连接是否牢固
- 尝试不同的USB线和电源适配器
- 检查设备是否有过热现象

## 预期功耗

**正常工作时**：
- CPU：约50-80mA
- WiFi：约100-200mA
- 显示屏：约50-100mA
- 传感器：约5-10mA
- **总计**：约200-400mA

**建议电源容量**：至少500mA，推荐1A以上

## 注意事项

1. **首次使用**：建议使用稳定的5V/2A电源适配器
2. **长期运行**：确保环境温度不超过40°C
3. **网络环境**：确保WiFi信号稳定，避免频繁重连
4. **定期检查**：通过串口监控设备状态

如果问题仍然存在，请检查：
- 电源适配器规格
- USB线质量
- 环境温度
- 网络稳定性 